<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Car Listing Page</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700,800&display=swap" rel="stylesheet">

    <link rel= "stylesheet" type= "text/css" href= "https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700,800&display=swap">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/open-iconic-bootstrap.min.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/animate.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/owl.carousel.min.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/owl.theme.default.min.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/magnific-popup.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/aos.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/ionicons.min.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/bootstrap-datepicker.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/jquery.timepicker.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/flaticon.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/icomoon.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/style.css') }}">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  </head>
    <header class="masthead">
        <div class="container px-5">
            <div class="row gx-5">
                <div class="col-lg-9">
                    <div class="card shadow">
                        <div class="card-body" id="paymentBody">
                            <h5 class="card-title">Payment Details</h5>
                            <hr/>
                            <div class="card-body" id="creditCardInfo">
                                <hr class="hr-sm">
                                <form id="ccForm" onsubmit="handleForm(event)" action="/rental" method="POST">
                                    <div class="mb-3">
                                    <label for="creditCardInput" class="form-label">Card Number</label>
                                    <input class="form-control" type="tel" name="ccno" placeholder="XXXXXXXXXXXXXXXX" pattern="^(?:4[0-9]{12}(?:[0-9]{3})?|(?:5[1-5][0-9]{2}|222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|6(?:011|5[0-9]{2})[0-9]{12}|(?:2131|1800|35\d{3})\d{11})$" title="Please enter a Credit Card number.">
                                    </div>
                                    <div class="mb-3">
                                        <label for="nameInput" class="form-label" class="form-label">Name on card</label>
                                        <input class="form-control" type="tel" placeholder="Name on card" title="Please enter the name on the Credit Card.">
                                    </div>
                                    <div class="form-inline">
                                        <div class="mb-3 col-lg-5">
                                            <label for="expirationInput" class="form-label" class="form-label">Expiration Date (MM/YY)</label><br>
                                            <input class="form-control ccForm" type="tel" minlength="2" maxlength="2" size="2" placeholder="MM" pattern="^[0-9]*$" title="Please enter the month of expiry" required> / <input class="form-control ccForm" type="tel" minlength="2" maxlength="2" size="2" placeholder="YY" pattern="^[0-9]*$" title="Please enter the year of expiry (Last two digit)">
                                        </div>
                                        <div class="mb-3 col-lg-5">
                                            <label for="verificationInput" class="form-label" class="form-label">Card Verification Number (CVV)</label><br>   
                                            <input class="form-control ccForm" type="tel" minlength="3" maxlength="3" size="3" placeholder="CVC" pattern="^[0-9]*$" title="Please enter the credit card verficiation number">
                                        </div>
                                    </div>
                                    <input type="hidden" name="licensePlate" id="licensePlate" value="{{ license_plate }}">
                                    <input type="hidden" name="bookingDate" id="bookingDate" value="{{ start_date }} to {{ end_date}}">
                                    <input type="hidden" name="endDate" id="endDate" value="{{ end_date }}">    
                                </form>
                            </div>
                        </div>
                    </div>  
                </div>
                <div class="col-lg-3">
                    <div class="card shadow" id="paymentSide">
                        <div class="card-body" id="itemListings">
                            <h5 class="card-title">Your order</h5>
                            <hr/>
                            <div class="row align-items-start">
                                    <div class="card itemBorderless">
                                        <div class="card-body" id="card-body-text">
                                            <p class="card-text">{{ license_plate }}</p>
                                            <p class="card-text">{{ start_date }}</p>
                                            <p class="card-text">{{ end_date }}</p>
                                            <p class="card-text">{{ UserId }}</p>
                                            <p class="card-text lead fs-6">S$XXX</p>
                                        </div>
                                        <br>
                                        <button id="paymentFormBtn" class="btn btn-primary float-end" form="ccForm">Place order now</button>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <script>
        function handleForm(event) {
            event.preventDefault();
    
            const formData = new FormData(document.getElementById('ccForm'));
    
            fetch('/handle_booking', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.error('Error:', response.statusText);
                    throw new Error('Failed to handle booking');
                }
            })
            .then(data => {
                // Redirect to the received rentalId
                const rentalId = data.rentalId;
                window.location.href = `/rental/${rentalId}`;
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</head>
</body>
</html>